<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<link rel="stylesheet" href="/res/public/layui/css/layui.css" media="all">
<link rel="stylesheet" type="text/css" href="/res/css/style.css" />
<script src="/res/js/jquery-3.1.1.min.js"></script>
<script src="/res/public/layui/Area1.js" type="text/javascript"></script>
<script src="/res/public/layui/layui.js"></script>
<script type="text/javascript" src="/res/common/post.js<@resVersionDirective>?</@>"></script>
<script src="/res/public/layPage/laypage.js"></script>
<style>
.form-css .dl-form dd input[type='text'] {
	width: 100px;
}

.form-css .dl-form {
	margin-bottom: 0px;
}

.content .layui-form-radio:last-of-type {
	margin-right: 0px;
}
</style>
</head>
<body>
	<div class="jun-form-s form-css mt10" style="width: 580px;">
		<dl class="dl-form mt10 clr">
			<dt class="flt">产品类型：</dt>
			<dd class="flt layui-form content">
				<input type="radio" value="OPTICAL_CABLE" title="光缆" name="classify" checked>
				<input type="radio" value="ACCESSORIES" title="配件" name="classify"> 
				<input type="radio" value="PDS" title="综合布线" name="classify">
				<input type="radio" value="OTHERS" title="其它" name="classify"> 
				<input type="text" placeholder=""  autocomplete="off" class="layui-input frt" name="title"  id="otherProductTypeDesc">
				<!--              <select name="productType" lay-filter="productType"  style="width: 240px;" id="productType"> -->
				<!--                     <option value="OPTICAL_CABLE" selected>光缆</option> -->
				<!--                     <option value="ACCESSORIES">配件</option> -->
				<!--                     <option value="PDS">综合布线</option> -->
				<!--                     <option value="OTHERS">其他</option> -->
				<!--               </select> -->
			</dd>
		</dl>
		<dl class="dl-form mt10">
			<dt class="flt">转交对象：</dt>
			<dd class="flt layui-form pre">
				<input type="radio" value="manager" title="转交给销售代表" checked="" name="duixiang" lay-filter="duixiang" checked> <input type="radio" value="distributor"
					title="转交给分销商" name="duixiang" lay-filter="duixiang">
				<!--             <input class="inline" type="radio" lay-filter="isTransfer" name="isTransfer" value="manager" title="转交给销售代表" checked> -->
				<!--             <input class="inline" type="radio" lay-filter="isTransfer" name="isTransfer" value="distributor" title="转交给分销商"> -->
			</dd>
		</dl>
		<dl class="dl-form mt10 ml10">
			<dd class="flt ml20">
				<input type="text" style="width: 200px;" id="searchObject" placeholder="请输入员工姓名或部门" autocomplete="off" class="layui-input search"> <span
					class="iconfont icon-sousuo-sousuo frt mr10 c-9 cs-p" style="margin-top: -25px;" id="searchBtn"></span>
				<!--           <span class="iconfont icon-sousu cs-p" style="position: absolute;right: 30px;top: 10px;" id="searchBtn"></span> -->
			</dd>
			<dt class="flt fz12">省份：</dt>
			<dd class="flt layui-form dd-city">
				<select name="province" lay-filter="province" id="s_province" lay-search>
					<option value="">请选择省</option>
				</select>
			</dd>
		</dl>
	</div>
	<div class="transferToSale accountManagerList" style="width: 100%; box-sizing: border-box; padding: 0 20px; margin-right: 20px; margin-top: 10px;">
		<table class="layui-table pop table-css" lay-skin="line">
			<colgroup>
				<col width="30">
				<col width="100">
				<col width="100">
				<col width="100">
			</colgroup>
			<thead>
				<tr class="bor-no">
					<th></th>
					<th>公司销售</th>
					<th>电话</th>
					<th>部门</th>
				</tr>
			</thead>
			<tbody id="userTable_tbody">
				<tr class="bor-no">
					<th><input type="radio" value="" checked="" name="item"></th>
					<th>株洲</th>
					<th>12890865567</th>
					<th>南区部,销售一组</th>
				</tr>
				<tr class="bor-no">
					<th><input type="radio" value="" name="item"></th>
					<th>株洲</th>
					<th>12890865567</th>
					<th>南区部,销售一组</th>
				</tr>
				<tr class="bor-no">
					<th><input type="radio" value="" name="item"></th>
					<th>株洲</th>
					<th>12890865567</th>
					<th>南区部,销售一组</th>
				</tr>
			</tbody>
		</table>
	</div>
	<div class="transferToDistributor distributorList" style="display: none; width: 100%; box-sizing: border-box; padding: 0 20px; margin-right: 20px; margin-top: 10px;">
		<table class="layui-table pop table-css" lay-skin="line">
			<colgroup>
				<col width="30">
				<col width="200">
				<col width="150">
				<col width="200">
				<col width="100">
			</colgroup>
			<thead>
				<tr class="bor-no">
					<th></th>
					<th>公司名称</th>
					<th>销售代表/客户经理</th>
					<th>分销商对接人</th>
					<th>身份</th>
				</tr>
			</thead>
			<tbody id="distributorTable_tbody">
				<tr class="bor-no">
					<th><input type="radio" value="" checked="" name="item1"></th>
					<th>公司名称</th>
					<th>销售代表</th>
					<th>分销商对接人</th>
					<th>身份</th>
				</tr>
				<tr class="bor-no">
					<th><input type="radio" value="" name="item1"></th>
					<th>公司名称</th>
					<th>销售代表</th>
					<th>分销商对接人</th>
					<th>身份</th>
				</tr>
				<tr class="bor-no">
					<th><input type="radio" value="" name="item1"></th>
					<th>公司名称</th>
					<th>销售代表</th>
					<th>分销商对接人</th>
					<th>身份</th>
				</tr>
			</tbody>
		</table>
	</div>
	<div id="paginationDiv" style="margin-right: 8px; margin-top: -20px"></div>
	<div class="t-c">
	    <a class="form-btn layui-btn-small2 confirmChooseBtn" lay-submit lay-filter="submit" id="addBtn">提交</a>
        <a class="form-btn  layui-btn-primary layui-btn-small2 cancelChooseBtn ml10" id="cancelBtn">取消</a>
<!--               <button class="form-btn layui-btn-small2 confirmChooseBtn" onclick="confirmChooseBtn()">确定</button> -->
<!--       <button class="form-btn  layui-btn-primary layui-btn-small2 cancelChooseBtn ml10"  onclick="cancelChooseBtn()">取消</button> -->
	</div>
	<script type="text/javascript">
	
	    var index = parent.layer.getFrameIndex(window.name);//当前窗口的标识
		var _offerId = '${offerId}';
		var _province = '${province}';
// 		var _city = '${city}';
		//省市联动  star
		var areaData = Area;
		var $form;
		var form;
		var $;
		layui.use([ 'form', 'laydate', 'layer' ], function() {
			form = layui.form();
			$form = $('.form-css');
			$ = layui.jquery;
			layer = layui.layer;
			loadProvince();

			form.on('radio(duixiang)', function(data) {

				if (data.value == "transferToSale") {
					$('.transferToSale').show();
					$('.transferToDistributor').hide();
				} else if (data.value == "transferToDistributor") {
					$('.transferToSale').hide();
					$('.transferToDistributor').show();
				}

				var param = {};
				param.currentPageIndex = 1;
				param.province = _province;
				loadDATA(param);
			});
		});

		function loadProvince() {
			//     var proHtml = '';
			//         proHtml = '<option value="">全部</option>';
			//    for(var i = 0; i < areaData.length; i++) {
			//      proHtml += '<option value="' + areaData[i].provinceName + '">' +
			//           areaData[i].provinceName + '</option>';
			//    }
			//   //初始化省数据
			//      $form.find('select[name=province]').append(proHtml);
			//      form.render();
			//      form.on('select(province)', function(data) {
			//        var value = data.value;
			//     });

			var proHtml1 = '<option class="option1" value="' +"" + '" selected>'
					+ "全部" + '</option>';
			for (var i = 0; i < areaData.length; i++) {
				if (_province != '' && _province == areaData[i].provinceName) {
					proHtml1 += '<option class="option1" value="' + areaData[i].provinceName + '" selected='+'"selected">'
							+ areaData[i].provinceName + '</option>';
				} else {
					proHtml1 += '<option class="option1" value="' + areaData[i].provinceName + '">'
							+ areaData[i].provinceName + '</option>';
				}
			}
// 			if (_province != '') {
// 				var cities = getCityByProvince(areaData, _province);
// 				loadCity(cities, _city);
// 			}
			$form.find('select[name=province]').append(proHtml1);
			form.render();
			form.on('select(province)', function(data) {
				_province = data.value;

				//   	 $(".alloptions2").attr("selected",true);
				if (_province == "") {
					$form.find('select[name=province2]').find('option').each(
							function(i, n) {
								if ($(n).text() == "全部") {
									$(n).attr("selected", true);

								}
							})

				} else {
					$(".option2").attr("selected", false);
					$form.find('select[name=province2]').find('option').each(
							function(i, n) {
								if ($(n).text() == _province) {
									$(n).attr("selected", true);
								}
							})
				}

// 				var cities = getCityByProvince(areaData, _province);
// 				if (cities.length > 0) {
// 					loadCity(cities);

// 				} else {
// 					$form.find('select[name=city]').parent().hide();
// 				}
				var searchObject = $('#searchObject').val();
				var param = {};
				param.searchObject = searchObject;
				param.currentPageIndex = 1;
				param.province = _province;
				loadDATA(param);

				//      	form.render();
			});

// 			function getCityByProvince(areaData, provinceName) {
// 				var cities = [];
// 				$.each(areaData, function(index, item) {
// 					if (item.provinceName == provinceName) {
// 						cities = item.mallCityList;
// 						return false;
// 					}
// 				});
// 				return cities;
// 			}
			
// 		    function loadCity(citys, selCity) {
// 		        var cityHtml = '';
// 		        for(var i = 0; i < citys.length; i++) {
// 		            if(selCity != '' && selCity == citys[i].cityName) {
// 		                cityHtml += '<option value="' + citys[i].cityName + '" selected>' +
// 		                    citys[i].cityName + '</option>';
// 		            } else {
// 		                cityHtml += '<option value="' + citys[i].cityName + '">' +
// 		                    citys[i].cityName + '</option>';
// 		            }
// 		        }
// 		        $form.find('select[name=city]').html(cityHtml).parent().show();
// 		        form.render();

// 		    }
			form.on('select(province2)', function(data) {
				_province = data.value;
				//      var cities = getCityByProvince(areaData, _province);
				//      if(cities.length > 0) {
				//          loadCity(cities);
				//      } else {
				//          $form.find('select[name=city]').parent().hide();
				//      }
				var param = {};
				var searchObject = $('#searchObject').val();
				param.searchObject = searchObject;
				param.currentPageIndex = 1;
				param.province = _province;
				loadDATA(param);
			});
			
			
			
	        $('#cancelBtn').bind("click", function () {
	            parent.layer.close(index);//关闭当前窗口
	        });

	        form.on('submit(submit)', function(data) {
	            layer.load();
	            var param = {};
	            param.offerId = _offerId;
	            param.productType= $('input[name="classify"]:checked').val();
	            param.productTypeDesc= $("#otherProductTypeDesc").val();
	            param.transmitToSubject = $('input[name="duixiang"]:checked').val();
	            param.transferEmployId = $('input[name="userIdCheckBox"]:checked').val();
	            param.acceptUserName=$('input[name="userIdCheckBox"]:checked').attr("acceptUserName");
	            if(!doValidation(param)) {
	                layer.closeAll("loading");
	                return false;
	            }
	            postUtil.call("/mallOrder/api/mallInquiry/turnInquireToOut", {"jsonData": JSON.stringify(param)}, function (result) {
	                if(parent.turnInquireToOut) {
	                    var success = parent.turnInquireToOut(result);//调用父页面的渲染方法
	                    if (success) {
	                            parent.layer.close(index);//关闭当前窗口
	                    }
	                }
	                layer.closeAll("loading");
	            });
	        });
// 			var param={};
// 			param.currentPageIndex=1;
// 			param.province=_province;
// 	       	loadDATA(param);
// 	    });
	    
	    
	    function doValidation(data) {
	        var isPass = true;
	        var msg = "";
	        if(data.remark == "") {
	            msg += "请输入机会描述<br>";
	            isPass = false;
	        }
	        if(!data.transferEmployId) {
	        	if(data.transmitToSubject=='manager'){
	        		  msg += "请选择要转交的销售代表<br>";
	        	}else{
	        		  msg += "请选择要转交的分销商<br>";
	        	}
	            isPass = false;
	         }
	        if(!isPass) {
	            layer.msg(msg, {icon:5});
	        }
	        return isPass;
	    }
	    
		}

		//分页
		$(function() {
			var searchObject = $('#searchObject').val();
			var param = {};
			param.transmitToSubject = searchObject;
			param.searchObject = searchObject;
			param.currentPageIndex = 1;
			param.province = _province;
			loadDATA(param);
		});

		function loadDATA(param) {
			var transmitToSubject = $("input[name=duixiang]:checked").val();
			param.transmitToSubject = transmitToSubject;
			if ("manager" == transmitToSubject) {
				$(".distributorList").css("display", "none");
				$(".accountManagerList").css("display", "block");
				$("#searchObject").attr("placeholder", "请输入员工姓名或部门");
			} else {
				$(".distributorList").css("display", "block");
				$(".accountManagerList").css("display", "none");
				$("#searchObject").attr("placeholder", "请输入公司名称");
			}
			postUtil
					.call(
							"/mallOrder/api/mallInquiry/getSalesRepresentOrDistributor",
							param, function(result) {
								var pageNumber = result.pageNumber;
								var pageSize = result.pageSize;
								var totalPage = result.totalPage;
								var totalRow = result.totalRow;
								var dataList = result.list;
								renderTable(transmitToSubject, dataList);
								laypage({
									cont : 'paginationDiv',
									pages : totalPage,
									curr : pageNumber,
									total : totalRow,
									skip : true,
									jump : function(obj, first) {
										if (!first) {
											param.currentPageIndex = obj.curr;
											loadDATA(param);
										}
									}
								});
							});
		}

		function renderTable(transmitToSubject, dataList) {
			var length = dataList.length;
			if ("manager" == transmitToSubject) {
				var table = document.getElementById("userTable_tbody");
				table.innerHTML = "";
				userDataMap = {};
				if (length > 0) {
					for (var i = 0; i < dataList.length; i++) {
						var data = dataList[i];
						var userId = data.userId;
						userDataMap[userId] = data;
						var row = renderRow(data);
						table.appendChild(row);
					}
				} else {
					var html = '<tr class="bor-no" ><td colspan="4">暂无信息！</td></tr>';
					$(table).html(html);
				}

			} else {
				var table = document.getElementById("distributorTable_tbody");
				table.innerHTML = "";
				userDataMap = {};
				if (length > 0) {
					for (var i = 0; i < dataList.length; i++) {
						var data = dataList[i];
						var userId = data.userId;
						userDataMap[userId] = data;
						var row = renderRowDistributor(data);
						table.appendChild(row);
					}
				} else {
					var html = '<tr><td colspan="4">暂无信息！</td></tr>';
					$(table).html(html);
				}
			}

		}

		function renderRow(rowData) {

			var userId = rowData.userId;
			var userName = rowData.userName;
			var userRealName = rowData.userRealName;
			var pUserId = rowData.pUserId;
			var pUserName = rowData.pUserName;
			var sex = rowData.sex;
			var mobile = rowData.mobile;
			var email = rowData.email;
			var accountId = rowData.accountId;
			var accountName = rowData.accountName;
			var mainObjectId = rowData.mainObjectId;
			var mainObjectName = rowData.mainObjectName;
			var departmentId = rowData.departmentId;
			var departmentName = rowData.departmentName;

			var ul = document.createElement('tr');
			ul.appendChild(renderCell("userIdCheckBox", userId, userRealName,
					"width:3%;height:75px;"));
			ul.appendChild(renderCell(null, isExitsVariable(userRealName),
					null, "width:10%;height:75px;"));
			ul.appendChild(renderCell(null, isExitsVariable(mobile), null,
					"width:12%;height:75px;"));
			ul.appendChild(renderCell(null, isExitsVariable(departmentName),
					null, "width:12%;height:75px;"));
			return ul;
		}

		function renderRowDistributor(rowData) {
			var ul = document.createElement('tr');
			ul.appendChild(renderCell("userIdCheckBox", rowData.accountId,
					rowData.accountName, "width:3%;height:75px;"));
			ul.appendChild(renderCell(null,
					isExitsVariable(rowData.accountName), null,
					"width:20%;height:75px;"));
			ul
					.appendChild(renderCell(
							null,
							(isExitsVariable(rowData.pltSalesUserRealName)
									+ "/" + isExitsVariable(rowData.salesUserRealName)),
							null, "width:8%;height:75px;"));
			ul.appendChild(renderCell(null,
					isExitsVariable(rowData.storeContact), null,
					"width:8%;height:75px;"));
			ul.appendChild(renderCell(null, isExitsVariable(rowData.province),
					null, "width:8%;height:75px;"));
			return ul;
		}

		function renderCell(name, value, acceptName, style) {
			var li = document.createElement('td');
			if ("userIdCheckBox" == name) {
				li.innerHTML = '<input type="radio" name="userIdCheckBox" value="' + value + '" acceptUserName="'+acceptName+'"/>';
			} else {
				if (value) {
					li.innerText = value;
				} else {
					li.innerText = "--";
				}
			}
			return li;
		}

		function isExitsVariable(variableName) {
			try {
				if (typeof (variableName) == "undefined") {
					return "--";
				} else {
					return variableName;
				}
			} catch (e) {
			}
			return "--";
		}

		$(document).on("click", "#searchBtn", function() {
			var searchObject = $('#searchObject').val();
			var param = {};
			param.searchObject = searchObject;
			param.currentPageIndex = 1;
			param.province = _province;
			loadDATA(param);
		});

		document.onkeydown = function(e) {
			var ev = document.all ? window.event : e;
			if (ev.keyCode == 13) {
				var searchObject = $('#searchObject').val();
				var param = {};
				param.searchObject = searchObject;
				param.currentPageIndex = 1;
				param.province = _province;
				loadDATA(param);
			}
		}
	</script>
</body>
</html>
