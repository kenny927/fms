<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title></title>
    <link rel="stylesheet" href="/res/public/layui/css/layui.css<@resVersionDirective>?</@>"  media="all">
    <link rel="stylesheet" type="text/css" href="/res/css/style.css<@resVersionDirective>?</@>"/>
    <link rel="stylesheet" type="text/css" href="http://at.alicdn.com/t/font_wgxw75694927qfr.css<@resVersionDirective>?</@>"/>
    <script src="/res/js/jquery-3.1.1.min.js<@resVersionDirective>?</@>"></script>
    <script src="/res/public/layui/Area1.js<@resVersionDirective>?</@>" type="text/javascript"></script>
    <script src="/res/public/layui/layui.js<@resVersionDirective>?</@>"></script>
    <script src="/res/public/layui/layui-mz-min.js<@resVersionDirective>?</@>"></script>
    <script src="/res/js/MultiSelectDropList.js<@resVersionDirective>?</@>"></script>
    <script src="/res/public/layPage/laypage.js<@resVersionDirective>?</@>"></script>
	<script type="text/javascript" src="/res/common/post.js<@resVersionDirective>?</@>"></script>
	 <script src="/res/js/moment.js<@resVersionDirective>?</@>"></script>
	<script type="text/javascript" src="/res/public/layer/layer_util.js<@resVersionDirective>?</@>"></script>
	<script type="text/javascript" src="/res/js/mallCustomer/mallCustomerDetail.js<@resVersionDirective>?</@>"></script>
	<script type="text/javascript" src="/res/js/mallCustomer/customer_visit_record.js<@resVersionDirective>?</@>"></script>
  </head>
  <style>
  .edit_back{}
  
  </style>
  <body>
    <section id="itocCenter">
         <section class="itocContent">
          <div class="itocMain">
            <div style="width:100%;box-sizing:border-box;padding:0 20px;margin-right:20px; margin-top:10px;">
                <div class="clr">
                    <div class="flt" style="width: 48%;margin-right:2%;">
                     <h3 class="mb5"><span class="accountNameHeader"></span><span class="c-h frt fz12 cs-p" id="editSystemAccountBtn">编辑</span></h3>
                      <blockquote class="layui-elem-quote layui-quote-nm layui-elem-bor customerBase" style="height: 90px;">
                      </blockquote>
                    </div>
                    <div class="flt" style="width: 50%;">
                     <h3 class="mb5">客户介绍(长度限制为500)<span class="c-h frt fz12 cs-p "><span class="accountIntroduceBtn" onclick="updateAccountIntroduce()">编辑</span></span></h3>
                      <blockquote class="layui-elem-quote layui-quote-nm layui-elem-bor edit_back" id="accountIntroduceEdit" style="line-height: 15px;height: 90px;">
                        <div contenteditable="false" class="accountIntroduceContent" style="height:85px;overflow-y:scroll;"></div>
                      </blockquote>
                    </div>
                </div>  
            </div>
           <div style="width:100%;box-sizing:border-box;padding:0 20px;margin-right:20px; margin-top:10px;">
            <h3 class="mb5">联系人<span class="c-h frt fz12 cs-p" id="addSystemAccountLinkmanBtn" style="display:none">新建</span><span class="c-h frt fz12 cs-p mr10" id="addSystemAuthorizeUserBtn" style="display:none">创建商城账号</span></h3>
            <table lay-skin="line" class="layui-table pop table-css linkmanTable" >
                <colgroup>
                  <col  width="60">
                  <col  width="150">
                  <col  width="100">
                  <col  width="100">
                  <col  width="100">
                  <col  width="130">
                  <col  width="130">
                  <col  width="100">
                  <col  width="100">
                </colgroup>
                  <thead>
                    <tr class="bor-no">
                      <th ></th>
                      <th >创建时间</th>
                      <th >部门</th>
                      <th >职务</th>
                      <th >联系人</th>
                      <th >手机号</th>
                      <th >座机</th>
                      <th >邮箱</th>
                      <th >操作</th>
                    </tr> 
                  </thead>
                <tbody>
                </tbody>
                </table>
                <div id="paginationDivLinkman" style="margin-right:-13px;margin-top:-10px"></div>
            </div>
            <div style="width:100%;box-sizing:border-box;padding:0 20px;margin-right:20px; margin-top:10px;">
	        <h3 class="mb5">商城账号</h3>
	            <table lay-skin="line" class="layui-table pop table-css authorizeTable" >
	                <colgroup>
	                  <col  width="150">
	                  <col  width="100">
	                  <col  width="100">
	                  <col  width="100">
	                  <col  width="100">
	                  <col  width="100">
	                  <col  width="100">
	                </colgroup>
	                  <thead>
	                    <tr class="bor-no">
	                      <th >注册时间</th>
	                      <th >用户名</th>
	                      <th >性别</th>
	                      <th >手机</th>
	                      <th >邮箱</th>
	                      <th >终端来源</th>
	                      <th >邀请人</th>
	                    </tr> 
	                  </thead>
	                <tbody>
	                </tbody>
	                </table>
            </div>
           <div style="width:100%;box-sizing:border-box;padding:0 20px;margin-right:20px;">
            <h3 class="mb5">销售机会<span class="c-h frt fz12 cs-p" id="addSalesOpportunityBtn" style="display:none">新建</span></h3>
            <table lay-skin="line" class="layui-table pop table-css customerSalesOpportunityTable" >
                <colgroup>
                  <col  width="150">
                  <col  width="100">
                  <col  width="100">
                  <col  width="100">
                  <col  width="200">
                  <col  width="300">
                  <col  width="100">
                  <col  width="80">
                  <col  width="60">
                </colgroup>
                  <thead>
                    <tr class="bor-no">
                      <th >创建时间</th>
                      <th >类型</th>
                      <th >等级</th>
                      <th >来源</th>
                      <th >联系人</th>
                      <th >内容</th>
                      <th >录入人</th>
                      <th >转询单</th>
                      <th >操作</th>
                    </tr> 
                  </thead>
                <tbody>
               
                </tbody>
                </table>
                <div id="paginationDivCustomerSalesOpportunity" style="margin-right:-13px;margin-top:-10px"></div>
            </div>
           <div style="width:100%;box-sizing:border-box;padding:0 20px;margin-right:20px;" style="display:none">
            <h3 class="mb5">拜访记录<span class="c-h frt fz12 cs-p" id="insertVisitRecord" style="display:none"><a class="fz12" href="javascript:addVisitRecord(_accountId);">新建</a></span></h3>
            <table lay-skin="line" class="layui-table pop table-css customerVisitingRecordTable" >
                <colgroup>
                  <col  width="150">
                  <col  width="100">
                  <col  width="100">
                  <col  width="100">
                  <col  width="300">
                  <col  width="100">
                  <col  width="100">
                </colgroup>
                  <thead>
                    <tr class="bor-no">
                      <th >时间</th>
                      <th >方式</th>
                      <th >联系人</th>
                      <th >职务</th>
                      <th >内容</th>
                      <th >跟进人</th>
                      <th >操作</th>
                    </tr> 
                  </thead>
                <tbody>
                
                </tbody>
                </table>
                <div id="paginationDivCustomerVisitingRecord" style="margin-right:-13px;margin-top:-10px"></div>
            </div>
            <div style="width:100%;box-sizing:border-box;padding:0 20px;margin-right:20px;">
            <h3 class="mb5">客户询单</h3>
            <table lay-skin="line" class="layui-table pop table-css mallInquireOrderListTable" >
                <colgroup>
                  <col  width="150">
                  <col  width="150">
                  <col  width="250">
                  <col  width="100">
                  <col  width="100">
                   <col  width="100">
                </colgroup>
                  <thead>
                    <tr class="bor-no">
                      <th >创建时间</th>
                      <th >询单编号</th>
                      <th >内容</th>
                      <th >来源</th>
                      <th >状态</th>
                      <th>跟进人</th>
                    </tr> 
                  </thead>
                <tbody>
                </tbody>
                </table>
                <div id="paginationDivMallInquireOrderList" style="margin-right:-13px;margin-top:-10px"></div>
            </div>
           <div style="width:100%;box-sizing:border-box;padding:0 20px;margin-right:20px;">
            <h3 class="mb5">客户订单</h3>
            <table lay-skin="line" class="layui-table pop table-css mallOrderTable" >
                <colgroup>
                  <col  width="150">
                  <col  width="250">
                  <col  width="250">
                  <col  width="100">
                  <col  width="100">
                </colgroup>
                  <thead>
                    <tr class="bor-no">
                      <th >下单时间</th>
                      <th >订单编号</th>
                      <th >供应商</th>
                      <th >订单金额</th>
                      <th >订单状态</th>
                    </tr> 
                  </thead>
                <tbody>
                </tbody>
                </table>
                <div id="paginationDivMallOrder" style="margin-right:-13px;margin-top:-10px"></div>
            </div>
           <div style="width:100%;box-sizing:border-box;padding:0 20px;margin-right:20px;">
            <h3 class="mb5">项目列表</h3>
            <table lay-skin="line" class="layui-table pop table-css orderProjectTable" >
                <colgroup>
                  <col  width="150">
                  <col  width="100">
                  <col  width="300">
                  <col  width="300">
                  <col  width="100">
                  <col  width="100">
                </colgroup>
                  <thead>
                    <tr class="bor-no">
                      <th >报备时间</th>
                      <th >等级</th>
                      <th >项目名称</th>
                      <th >业主方</th>
                      <th >项目地</th>
                      <th >项目状态</th>
                    </tr> 
                  </thead>
                <tbody>
                
                </tbody>
                </table>
                <div id="paginationDivOrderProject" style="margin-right:-13px;margin-top:-10px"></div>
            </div>
           <div style="width:100%;box-sizing:border-box;padding:0 20px;margin-right:20px;">
            <h3 class="mb5">客户流转</h3>
            <table lay-skin="line" class="layui-table pop table-css customerTransmitRecordTable" >
                <colgroup>
                  <col  width="150">
                  <col  width="100">
                  <col  width="100">
                  <col  width="400">
                </colgroup>
                  <thead>
                    <tr class="bor-no">
                      <th >时间</th>
                      <th >操作人</th>
                      <th >类型</th>
                      <th >操作记录</th>
                    </tr> 
                  </thead>
                <tbody>

                </tbody>
                </table>
                <div id="paginationDivCustomerTransmitRecord" style="margin-right:-13px;margin-top:-10px"></div>
            </div>
          </div>
         </section>
    </section>

<script type="text/javascript">
   var _accountId='${accountId}';
   var _accountManageName = '';
   var _addSystemAccountLinkmanBtn='${_addSystemAccountLinkmanBtn}';
   var _addSystemAuthorizeUserBtn='${_addSystemAuthorizeUserBtn}';
   var _addSalesOpportunityBtn='${_addSalesOpportunityBtn}';
   var _insertVisitRecord='${_insertVisitRecord}';
   var _existAuthorizeUser='${_existAuthorizeUser}';
   if(_addSystemAccountLinkmanBtn=="true"){
		$("#addSystemAccountLinkmanBtn").css("display","block");
	}
	if(_addSalesOpportunityBtn=="true"){
		$("#addSalesOpportunityBtn").css("display","block");
	}
	if(_insertVisitRecord=="true"){
		$("#insertVisitRecord").css("display","block");
	}
	if(_addSystemAuthorizeUserBtn=="true"){
		if(_existAuthorizeUser=="N"){
			$("#addSystemAuthorizeUserBtn").css("display","block");
		}
	}
   var layer;
   layui.use(['layer'], function () {
       layer = layui.layer;
       //新增联系人按钮事件
       $('#addSystemAccountLinkmanBtn').bind("click", function () {
           layer.open({
               skin: 'msgskin',
               title: "新增联系人",
               type: 2,
               area: ['450px', '500px'],
               fixed: false, //不固定
               maxmin: true,
               content: '/systemAccountLinkman/preAddSystemAccountLinkman?accountId=' + _accountId
           });
       });
       //新增销售机会按钮事件
       $('#addSalesOpportunityBtn').bind("click", function () {
           layer.open({
               skin: 'msgskin',
               title: '新建销售机会<span class="fz12">（客户所有者：<span>'+_accountManageName+'</span>）</span>',
               type: 2,
               area: ['750px', '500px'],
               fixed: false, //不固定
               maxmin: true,
               content: '/customer/salesOpportunity/preAdd?accountId=' + _accountId
           });
       });
       
       //生成商城账号
       $('#addSystemAuthorizeUserBtn').bind("click", function () {
    	   var linkmanSel=$(".linkmanTable input[name=linkmanIdSel]:checked");
    	   if(linkmanSel.length==0){
    		   layer.msg("请选择一个联系人！");
    		   return false;
    	   }
/*     	   var isPrimary=linkmanSel.attr("isPrimary");
    	   if(isPrimary=="N"){
    		   layer.msg("请选择主要联系人！");
    		   return false;
    	   } */
    	   
    	   var linkmanTelephone=linkmanSel.attr("linkmanTelephone");
    	   if(!/^0?1[3|4|5|7|8][0-9]\d{8}$/.test(linkmanTelephone)){
    		   layer.msg("联系人联系方式非手机号码，无法创建！");
               return false;
           }
    	   var linkmanId=linkmanSel.val();
    		var param={};
    		param.linkmanId=linkmanId;
    		postUtil.call("/mallCustomer/generateAuthorizeUser", param,function(data){
    			var status=data.STATUS;
    			if("SUCCESS"==status){
    				    layer.msg("商城账号创建成功!", {icon: 6});
    					var param1={};
    					param1.currentPageIndex=1;
    					param1.accountId=_accountId;
    					loadLinkmanlist(param1);
    					loadAuthorizeUser(param1);
    					$("#addSystemAuthorizeUserBtn").css("display","none");
    			}else{
    				layer.msg(data.MSG, {icon: 5});
    			}
    		})
       });
       
       
       $('#editSystemAccountBtn').bind("click", function () {
           layer.open({
               title: '修改客户信息',
               skin: 'msgskin',
               area: ['460px', '558px'],
               type: 2,
               btn: false,
               content: ['/systemAccount/preEditSystemAccount/'+_accountId,'no'],
           })
       });
   });
   //新增联系人回调函数
   function addAccountLinkmanCallback(result) {
	   var isPass = true;
       if (result.STATUS == "SUCCESS") {
           isPass = true;
       } else {
           isPass = false;
       }
       if(isPass){
    	   var param={};
    	   param.currentPageIndex=1;
    	   param.accountId=_accountId;
    	   loadLinkmanlist(param);
    	   loadMallCustomer(param);
    	   loadAuthorizeUser(param);
       }
       return isPass;
   }
   
   //修改联系人回调函数
   function updateAccountLinkmanCallback(result) {
	   var isPass = true;
       if (result.STATUS == "SUCCESS") {
           isPass = true;
       } else {
           isPass = false;
       }
       if(isPass){
    	   var param={};
    	   param.currentPageIndex=1;
    	   param.accountId=_accountId;
    	   loadLinkmanlist(param);
    	   loadMallCustomer(param);
    	   loadAuthorizeUser(param);
       }
       return isPass;
   }

   //新增销售机会回调函数
   function addSalesOpportunityCallback(result) {
       var isPass = true;
       if (result.STATUS == "SUCCESS") {
           layer.msg("新增销售机会成功", {icon: 6});
           isPass = true;
       } else {
           layer.msg("新增销售机会失败:" + result.MSG, {icon: 5});
           isPass = false;
       }
        if(isPass){
        	 var param={};
             param.currentPageIndex=1;
             param.accountId=_accountId;
             loadCustomerSalesOpportunity(param);
             loadMallCustomer(param);
        }
       return isPass;
   }

   function editAccount(result){
	   var param={};
	   param.currentPageIndex=1;
	   param.accountId=_accountId;
	   loadMallCustomer(param);
       return true;
   }
   
   function saveVisitRecordCallback(result){
	   var isPass = true;
       if (result.success) {
           layer.msg("新增拜访记录成功", {icon: 6});
           isPass = true;
       } else {
           layer.msg("新增拜访记录失败:" + result.MSG, {icon: 5});
           isPass = false;
       }
        if(isPass){
        	 var param={};
             param.currentPageIndex=1;
             param.accountId=_accountId;
             loadCustomerVisitingRecord(param);
             loadLinkmanlist(param);
        }
        return isPass;
   }
   
   function updateVisitRecordCallback(result){
	   var isPass = true;
       if (result.success) {
           layer.msg("修改拜访记录成功", {icon: 6});
           isPass = true;
       } else {
           layer.msg("修改拜访记录失败:" + result.MSG, {icon: 5});
           isPass = false;
       }
        if(isPass){
        	 var param={};
             param.currentPageIndex=1;
             param.accountId=_accountId;
             loadCustomerVisitingRecord(param);
             loadLinkmanlist(param);
        }
        return isPass;
   }
   
   function refreshlinkmanlist(){
        	 var param={};
             param.currentPageIndex=1;
             param.accountId=_accountId;
             loadLinkmanlist(param);
   }
</script>
  </body>
</html>